<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/">
<head th:replace="~{/common/config.html :: config}">
</head>
<body>
	<header th:replace="~{/common/header.html :: header}"></header>

	<main class="main">
		<section th:replace="~{/common/breadcrumb.html :: breadcrumb}"></section>
		<section class="container ">
			<!-- Title -->
			<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
				<h2 class="mb-1">발주 수정 화면</h2>
			</div>
			<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-2">
				<h5 class="mb-1">발주번호 : [[${details[0].pch_code}]]</h5>
			</div>
			<div class="table-responsive  rounded">
				<table class="table table-bordered align-middle">
					<thead class="table-light text-center">
						<tr>
							<th class="info-label table-light" colspan="5">발주처 정보</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="info-label">회사명</td>
							<td class="value-cell" colspan="4">[[${details[0].company_name}]]</td>
						</tr>
						<tr>
							<td class="info-label">사업자번호</td>
							<td class="value-cell">[[${details[0].biz_num}]]</td>
							<td class="info-label">대표자</td>
							<td class="value-cell" colspan="2">[[${details[0].ceo_name}]]</td>
						</tr>
						<tr>
							<td class="info-label">담당자</td>
							<td class="value-cell">[[${details[0].manager_name}]]</td>
							<td class="info-label">연락처</td>
							<td class="value-cell" colspan="2">[[${details[0].phone_num}]]</td>
						</tr>
						<tr>
							<td class="info-label">주소</td>
							<td class="value-cell" colspan="5">[[${details[0].addr1 + details[0].addr2}]]</td>
						</tr>
					</tbody>
				</table>
			</div>

			<div class="table-responsive  rounded">
				<h5 class="">발주정보</h5>
				<table class="table align-middle table-bordered">
					<tr>
						<td class="info-label">발주번호</td>
						<td class="value-cell">[[${details[0].pch_code}]]</td>
						<td class="info-label">발주상태</td>
						<td class="value-cell">[[${details[0].pch_status}]]</td>
					</tr>
					<tr>
						<td class="info-label">발주일자</td>
						<td class="value-cell">[[${details[0].request_date.substring(0,10)}]]</td>
						<td class="info-label">납기요청일</td>
						<td class="value-cell">[[${details[0].due_date.substring(0,10)}]]</td>
					</tr>
					<tr>
						<td class="info-label">결제 금액</td>
						<td class="value-cell">[[${#numbers.formatDecimal(details[0].pay_amount, 0, 'COMMA', 0, 'POINT')}]] 원</td>
						<td class="info-label">결제 수단</td>
						<td class="value-cell">[[${details[0].pay_method}]]</td>
					</tr>
					<tr>
						<td class="info-label">발주 담당자</td>
						<td class="value-cell">[[${details[0].emp_name}]]</td>
						<td class="info-label"></td>
						<td class="value-cell"></td>
					</tr>
					<tr>
						<td class="info-label">비고</td>
						<td class="value-cell" colspan="3">[[${details[0].memo}]]</td>
					</tr>
				</table>
			</div>

			<!-- 주문항목 List Table -->
			<form id="orderForm" th:action="@{/purchase/update}" method="post">
				<div class="table-responsive  rounded">
					<h5 class="">발주 제품 내역</h5>
					<table class="table table-hover align-middle table-bordered">
						<thead class="table-light text-center">
							<tr>
								<th scope="col"><input type="checkbox" id="checkAll"></th>
								<th scope="col">#</th>
								<th scope="col">제품코드</th>
								<th scope="col">제품명</th>
								<th scope="col">규격</th>
								<th scope="col">주문수량</th>
								<th scope="col">단위</th>
								<th scope="col">제품단가(원)</th>
								<th scope="col">구매금액(원)</th>
								<th scope="col">대분류</th>
								<th scope="col">소분류</th>
							</tr>
						</thead>
						<tbody id="product-tbody">
							<tr th:each="d, no : ${details}">
								<td><input type="checkbox" class="row-check"></td>
								<td>[[${no.count}]]</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_code" value="[[${d.item_code}]]" readonly class="form-control-plaintext">
								</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_name" value="[[${d.item_name}]]" readonly class="form-control-plaintext">
								</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_spec" value="[[${d.item_spec}]]" readonly class="form-control-plaintext">
								</td>
								<td>
									<input type="number" min="1" name="items[[${no.index}]].item_qty" value="[[${d.item_qty}]]" class="form-control qty-input" style="text-align:right;">
								</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_unit" value="[[${d.item_unit}]]" readonly class="form-control-plaintext">
								</td>
								<td>
									<input type="number" min="0" name="items[[${no.index}]].item_cost" value="[[${d.item_cost}]]" class="form-control cost-input" style="text-align:right;">
								</td>
								<td class="amount-cell" style="text-align:right;">
									[[${#numbers.formatDecimal(d.item_qty * d.item_cost, 0, 'COMMA', 0, 'POINT')}]]
								</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_class1" value="[[${d.item_class1}]]" readonly class="form-control-plaintext">
								</td>
								<td>
									<input type="text" name="items[[${no.index}]].item_class2" value="[[${d.item_class2}]]" readonly class="form-control-plaintext">
								</td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td class="info-label" colspan="2">합계</td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td align="right" id="total-amount">[[${#numbers.formatDecimal(details[0].pay_amount, 0, 'COMMA', 0, 'POINT')}]]</td>
								<td></td>
								<td></td>
							</tr>
						</tfoot>
					</table>
				</div>
				<!-- 선택 삭제 버튼 -->
				<div class="mb-3">
					<button type="button" class="btn btn-danger" id="deleteSelectedBtn">선택 삭제</button>
				</div>

				<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-end mb-4">
					<!-- 수정 버튼 -->
					<div class="mt-4 d-flex gap-2">
						<div class="ms-auto">
							<button type="submit" class="btn btn-success" id="submitBtn">
								<i class="bi bi-pencil-square"></i> 수정
							</button>
						</div>
					</div>
				</div>
			</form>
		</section>
	</main>

	<div id="modalContainer"></div>

	<footer th:replace="~{/common/footer.html :: footer}"></footer>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			// 모든 체크박스 제어 (전체 선택)
			const checkAllBox = document.getElementById('checkAll');
			checkAllBox.addEventListener('change', function () {
				document.querySelectorAll('.row-check').forEach(chk => chk.checked = this.checked);
			});

			// 수량, 단가 변경 시 구매금액 및 총합계 갱신
			const qtyInputs = document.querySelectorAll('.qty-input');
			const costInputs = document.querySelectorAll('.cost-input');
			
			function updateRowAmount(row) {
				const qtyInput = row.querySelector('.qty-input');
				const costInput = row.querySelector('.cost-input');
				const amountCell = row.querySelector('.amount-cell');
				
				let qty = parseInt(qtyInput.value);
				let cost = parseInt(costInput.value);
				
				if (isNaN(qty) || qty < 1) qty = 1;
				if (isNaN(cost) || cost < 0) cost = 0;

				const amount = qty * cost;
				amountCell.textContent = amount.toLocaleString();
				return amount;
			}

			function updateTotalAmount() {
				let total = 0;
				document.querySelectorAll('#product-tbody tr').forEach(row => {
					const qty = parseInt(row.querySelector('.qty-input').value) || 0;
					const cost = parseInt(row.querySelector('.cost-input').value) || 0;
					total += qty * cost;
				});
				document.getElementById('total-amount').textContent = total.toLocaleString();
			}

			function onInputChange() {
				const row = this.closest('tr');
				updateRowAmount(row);
				updateTotalAmount();
			}

			qtyInputs.forEach(input => input.addEventListener('input', onInputChange));
			costInputs.forEach(input => input.addEventListener('input', onInputChange));

			// 선택 삭제 버튼
			document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
				const tbody = document.getElementById('product-tbody');
				const checkedBoxes = tbody.querySelectorAll('.row-check:checked');
				if (checkedBoxes.length === 0) {
					alert('삭제할 행을 선택하세요.');
					return;
				}
				checkedBoxes.forEach(chk => {
					const row = chk.closest('tr');
					tbody.removeChild(row);
				});
				updateTotalAmount();
			});

			// 폼 제출 전 유효성 검사
			document.getElementById('orderForm').addEventListener('submit', function (e) {
				const rows = document.querySelectorAll('#product-tbody tr');
				if (rows.length === 0) {
					alert('최소 한 개 이상의 제품이 있어야 합니다.');
					e.preventDefault();
					return false;
				}

				for (const row of rows) {
					const qtyInput = row.querySelector('.qty-input');
					const qty = parseInt(qtyInput.value);
					if (isNaN(qty) || qty < 1) {
						alert('수량은 1 이상이어야 합니다.');
						qtyInput.focus();
						e.preventDefault();
						return false;
					}
				}
			});
		});
	</script>
</body>
</html>
